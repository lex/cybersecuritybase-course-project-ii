# Setup

The setup we'll be using is as follows:

* OSX 10.12.6 as the host running Snort 2.9.11.1 with the 29111 registered ruleset
* Kali 2018.1 running in VMWare Fusion
* Metasploitable3 running in VMWare Fusion, commit 76738815833b408e54aff9ada4330235ddf2bff3

The IP addresses:

* 192.168.68.129 - Kali
* 192.168.68.130 - Metasploitable

The virtual machines are connected to each other via the private network supplied by VMWare. There's some [bug (or a feature?)](https://github.com/nmap/nmap/issues/303) in VMWare Fusion's NAT which makes it crash while port scanning, but it seems to work just fine this way.

Let's start by scanning the target:
![Some portscanning](img/portscan.png)

Port scanning could be considered an attack, at least it's considered illegal in Finland. Snort was silent about it though. It seems like there isn't any support for detecting it by default (though I've recently heard there might be!). Defending against port scanning could be hard, since the attacker could just switch IP addresses or scan the ports very slowly.

We can see from the scan that the services match the ports listed in the [vulnerabilities section](https://github.com/rapid7/metasploitable3/wiki/Vulnerabilities) of metasploitable3's wiki.

# Attacking

## Exploit #1 - Apache Struts - CVE-2016-3087

Let's start with Struts. According to the [list of vulnerabilities](https://github.com/rapid7/metasploitable3/wiki/Vulnerabilities#apache-struts), Struts should be vulnerable to `CVE-2016-3087`, and there's a module called `exploit/multi/http/struts_dmi_rest_exec` in metasploit for it.

Let's exploit it:

![Exploit time](img/struts_exploit.png)

Snort doesn't see the exploit with the default settings, but if we uncomment the lines 118 and 119 from server-apache.rules and add the port 8282 to be monitored for HTTP traffic, it should detect it:

![Snort seems to detect it](img/struts_snort.png)

While we're in, let's grab some user accounts for later use:

![User accounts](img/struts_users.png)

## Bruteforcing our way in through SSH

Now that we know the user accounts on the system, let's try guessing passwords for them:

![Setting up SSH bruteforcing](img/ssh_bruteforce.png)

Now let's run it:

![SSH bruteforcing success](img/ssh_bruteforce_success.png)

Seems like the user vagrant has the password vagrant, which can be verified from [here.](https://github.com/rapid7/metasploitable3/wiki/Configuration#credentials) The shell didn't open for some reason, but we got shell access already with Struts, so it doesn't matter.

Were the password a bit stronger, one could use for example the password lists provided by metasploit to try to guess the password. Going through password lists takes time, but the only remaining option would be to just blindly generate and try different passwords, which is even slower.

In this case Snort didn't react to the bruteforcing in any way. We only tried to log in with 20 different users and their usernames as passwords, so maybe Snort could be configured to check for long running SSH login attempts. One could also use other software like [Fail2Ban](https://en.wikipedia.org/wiki/Fail2ban) to defend against bruteforcing, or just disable logging in with a password altogether. If disabling password login is out of the question, then strong passwords should be forced. Limiting SSH access to specific IPs could work too.

## Exploit #2 - WordPress - CVE-2016-1209

Let's try WordPress next. [The wiki](https://github.com/rapid7/metasploitable3/wiki/Vulnerabilities#wordpress) says that there's a WordPress instance running on port 8585, and that there should be a vulnerable [Ninja form](https://ninjaforms.com) somewhere.

Looks like there's a form at `/wordpress/index.php/king-of-hearts/`. Let's try that with the module
`multi/http/wp_ninja_forms_unauthenticated_file_upload`.

Let's set up the exploit:

![Setting up the exploit](img/wordpress_setup.png)

Time to run it:

![Exploit time](img/wordpress_exploit.png)

Looks successful to me.

If we uncomment the line `2284` in `server-webapp.rules` and add the port 8585 to be monitored for HTTP traffic, Snort seems to be able to detect the attack as well:

![Snort found us](img/wordpress_snort.png)

## Exploit #3 - JMX - CVE-2015-2342

Now let's try JMX. According to the [wiki](https://github.com/rapid7/metasploitable3/wiki/Vulnerabilities#jmx), JMX should be accessible from the port 1617.

Let's set up the exploit:

![Setting up stuff for the exploit](img/jmx_setup.png)

Time to run it:

![Success](img/jmx_exploit.png)

If we uncomment the line `1313` in `server-other.rules`, Snort seems to be able to detect the attack:

![Snort found us](img/jmx_snort.png)

# Is it easier to fix the application than to detect attacks?

Basically, yes if the application can just be updated to a newer version. Detection seems pretty easy too (at least to an end user), but there's more things to consider than just detection.

It seems like Snort needs to be specifically configured to detect specific attacks. It's understandable, because processing packets introduces overhead. Using multiple rules the packets could in theory be checked for every possible attack, which would probably make the latency pretty high when communicating with the server.

Now that cloud computing is the current trend, using Snort seems to be out of the question. Snort would still need to sit somewhere between the client and the application, and sometimes there isn't even any concrete virtual machine for the cloud user to configure.

I think one of the weaknesses of Snort is that it requires the rule sets to work. The rule sets only contain information about known attacks, so any new attacks not included in the rules won't be recognized. The rules also need to be updated (and configured afterwards).

An easier way would definitely be to update the used software as updates are released. Updates may break things, but that's what tests and different deployment stages are for. The developers might know about the vulnerabilities before they've been publicly announced, so the users might be safe by the time the exploiting begins.

Also, detecting attacks doesn't necessarily help, if the attacks still go through. It seems like [Snort can also be used to block the attacks it detects](http://manual-snort-org.s3-website-us-east-1.amazonaws.com/node26.html#SECTION003114000000000000000), which could be something worth looking into.

If "to fix the application" means actually fixing vulnerable software instead of just updating some third party software, there's a bit more to fixing it than just updating to a secure version. There might exist a case where the software is not that easy to fix, or the code isn't available, or the budget doesn't allow it, and the vulnerability is detectable and blockable. Then it just might make sense to leave the vulnerability there and just block any attempts to exploit it. Still, it might be possible to work around the detection or to find new vulnerabilities similar to the known one.
